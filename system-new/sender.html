<!DOCTYPE html>
<html>
    <head>
        <title>sender - camera</title>
    </head>
    <body>
        <h2>Webcam Stream</h2>
        <video id="localVideo" autoplay playsinline></video>

        <script>
            const localVideo = document.getElementById('localVideo');
            const socket = new WebSocket('ws://192.168.1.127:3000'); // WebSocket server URL
            let peerConnection;
            const params = new URLSearchParams(location.search);
            const senderId = params.get('id') || `send-${Math.random().toString(36).slice(2, 8)}`;
            const targetId = params.get('to'); // required to target a specific receiver

            // WebRTC configuration
            const configuration = {
                iceServers: [
                    {
                    urls: 'stun:stun.l.google.com:19302'
                    }
                ]
            };

            // Start webcam capture
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localVideo.srcObject = stream;
                startWebRTC(stream);
            })
            .catch(error => {
                console.error('Error accessing media devices.', error);
            });

            // create the peer connection - RTCPeerConnection
            function startWebRTC(stream) {
                peerConnection = new RTCPeerConnection(configuration);

                // Add all media tracks (audio + video) to the connection
                stream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, stream);
                });

                // ICE candidate handling
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        const payload = { type: 'candidate', candidate: event.candidate, from: senderId };
                        if (targetId) payload.to = targetId;
                        socket.send(JSON.stringify(payload));
                    }
                };

                // Create WebRTC offer
                peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true,
                })
                    .then(offer => {
                        let offerSDP = offer.sdp;
                        offerSDP = offerSDP.replace('useinbandfec=1', 'useinbandfec=1;profile-level-id=42e01f'); // For VP8

                        offer.sdp = offerSDP;
                        return peerConnection.setLocalDescription(offer);
                    })
                    .then(() => {
                        const payload = { type: 'offer', offer: peerConnection.localDescription, from: senderId };
                        if (targetId) payload.to = targetId;
                        socket.send(JSON.stringify(payload));
                    });
            }

            // WebSocket message handling for signaling
            socket.onmessage = async (message) => {
                const data = JSON.parse(message.data);

                // Only process messages from our target receiver (if specified)
                if (targetId && data.from && data.from !== targetId) return;

                if (data.type === 'answer') {
                    peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                } else if (data.type === 'candidate') {
                    peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            };

            // Register this sender with the signaling server
            socket.addEventListener('open', () => {
                socket.send(JSON.stringify({ type: 'register', id: senderId }));
                console.log('Registered sender with id:', senderId, 'target:', targetId);
            });
        </script>
    </body>
</html>